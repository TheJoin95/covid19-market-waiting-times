/*! covid19-market-waiting-times 2020-05-02 */
"use strict";function _typeof(e){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(a):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function asyncGeneratorStep(e,t,a,n,s,r,i){try{var o=e[r](i),l=o.value}catch(e){return void a(e)}o.done?t(l):Promise.resolve(l).then(n,s)}function _asyncToGenerator(e){return function(){var t=this,a=arguments;return new Promise(function(n,s){var r=e.apply(t,a);function i(e){asyncGeneratorStep(r,n,s,i,o,"next",e)}function o(e){asyncGeneratorStep(r,n,s,i,o,"throw",e)}i(void 0)})}}var API_DOMAIN_AVAILABLE=["api-geo-fr","api-geo-ny"],API_DOMAIN=API_DOMAIN_AVAILABLE[Math.floor(Math.random()*API_DOMAIN_AVAILABLE.length)],WaitingTimesAPI={fallbackGeocodeAPI:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?Address=%s&f=json",geocodeAPI:"https://api-geo.thejoin.tech/geocode?lat=%s&lng=%s",geocodeAPIClient:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=pjson&featureTypes=&location=%s,%s",logAPI:"https://api-geo.thejoin.tech/logger",feedbackAPI:"https://api-geo-fr.thejoin.tech/send-feedback",getPlaceByNameAPI:"https://api-geo-ny.thejoin.tech/places/get-by-name?q=%s&address=%s",getPlacesAPI:"https://"+API_DOMAIN+".thejoin.tech/places/explore?q=%s&address=%s",getPlacesAPIFallback:"https://api-geo-fr.thejoin.tech/places/explore-redis?q=%s&address=%s",searchSuggestAPI:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/suggest?text=%s&maxSuggestions=10&category=city,address&countryCode=&searchExtent=&location=&distance=&f=json",format:function(e){var t=[].slice.call(arguments,1),a=0;return e.replace(/%s/g,function(){return t[a++]})}},CONTENT_CONSTANTS={HELP_MODAL:{BODY:'\n      <p>Didn\'t find what you were looking for? <br/><u style="cursor: pointer" onclick="Utils.searchByNameModal()">Tap here to search by name üîç</u></p><input type="text" id="email" placeholder="Insert an email for an answer or leave blank" /><textarea placeholder="Write here your question or tips" rows="7"></textarea><small><i>Note: this is not a search box</i></small>\n    '}};Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return 180*this/Math.PI};var Utils={updateTimeout:null,geoErrorTimeout:null,suggestTimeout:null,geoErrorFailOverCount:0,sendFeedback:function(e){fetch(WaitingTimesAPI.feedbackAPI,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)})},sendError:function(e){e.ua=navigator.userAgent,e.date=(new Date).toString(),fetch(WaitingTimesAPI.logAPI,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)})},searchSuggest:function(e){clearTimeout(Utils.suggestTimeout),e.value.length>=2&&(Utils.suggestTimeout=setTimeout(_asyncToGenerator(regeneratorRuntime.mark(function t(){var a,n,s,r,i,o,l,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=WaitingTimesAPI.format(WaitingTimesAPI.searchSuggestAPI,e.value),t.next=3,fetch(a);case 3:if(n=t.sent,(s=document.getElementById("suggest-results")).innerHTML="",r=!0,!n.ok){t.next=13;break}return t.next=10,n.json();case 10:if(i=t.sent,[],i.suggestions.length>0)for(o in r=!1,i.suggestions)l=i.suggestions[o].text.slice(0,-5),(c=document.createElement("div")).className="item-suggest-result",c.setAttribute("onclick","document.getElementById('suggest-input').value = '"+l+"'; document.querySelector('#suggest-modal .container.teal .btn:nth-of-type(2)').click();"),c.innerHTML=l,s.appendChild(c);case 13:r&&(s.innerHTML='<div class="item-suggest-result">No results</div>');case 14:case"end":return t.stop()}},t)})),400))},setDefaultLocation:function(e,t,a){var n={address:e,latt:t,longt:a};localStorage.setItem("defaultLocation",JSON.stringify(n))},getDefaultLocation:function(){return JSON.parse(localStorage.getItem("defaultLocation"))},shouldShowWelcomeModal:function(){return true},showWelcomeModal:function(){var e=document.getElementById("welcome-modal");e.classList.add("show"),e.focus(),"Firenze"!==TimesApp.address&&(document.querySelector(".welcome-modal__actions").style.display="none")},hideWelcomeModal:function(){Utils.closeModal("welcome-modal"),window.localStorage.setItem("hasSeenWelcomeModal","true"),"Firenze"===TimesApp.address&&TimesApp.initGeodata()},filterSidebarList:function(e){window.filterSidebarTimeout=window.filterSidebarTimeout||null,clearTimeout(window.filterSidebarTimeout),filterSidebarTimeout=setTimeout(function(){for(var t=e.value,a=new RegExp(t,"i"),n=document.querySelectorAll(".sidebar__item"),s=0;s<n.length;s++){-1===n[s].getAttribute("title").search(a)&&t.length>=2?n[s].style.display="none":n[s].style.display="block"}},400)},showPlaceSidebar:function(){var e=document.getElementById("places-sidebar");e.classList.add("show"),e.focus(),document.getElementById("filter-sidebar").value="";var t=document.querySelector(".sidebar__items");if(t.innerHTML="",Object.keys(TimesApp.menuPlaces).length>0)for(var a in TimesApp.menuPlaces){var n=TimesApp.menuPlaces[a].data,s=TimesApp.menuPlaces[a].waitTimeArr,r="recent";if(void 0!==n.updatetime){var i=new Date(1e3*n.updatetime);r=i.getHours()+":"+("0"+i.getMinutes()).substr(-2)}var o=s[1],l=0===s[0],c="string"==typeof o&&!l;o=l?"Closed":o;var d=l?"Closed":o+" min";d=c?"No info":d;var p=document.createElement("h2");p.className="sidebar__item--title sidebar__item--title--bg-"+o.toString().toLowerCase()+"min",p.innerHTML=n.name;var u=document.createElement("p");u.className="sidebar__item--subtitle",u.innerHTML=n.address;var m=document.createElement("div");m.className=n.place_id+" sidebar__item--badge";var g=document.createElement("div");g.className="text-center bg-"+o.toString().toLowerCase()+"min",g.innerHTML="<span>"+d+"</span><br/>Last update <time>"+r+"</time>",m.appendChild(g);var f=document.createElement("div");f.setAttribute("onclick","TimesApp.mapMarkers['"+a+"'].fireEvent('click')"),f.className="sidebar__item",f.setAttribute("title",n.name+" "+n.address+" - wait time: "+o+"min"),f.appendChild(p),f.appendChild(u),f.appendChild(m),t.appendChild(f)}},showPlaceModal:function(e){var t=TimesApp.menuPlaces[e].data,a=TimesApp.menuPlaces[e].waitTimeArr,n=document.getElementById("place-modal");n.setAttribute("data-place-id",t.place_id);var s="recent";if(void 0!==t.updatetime){var r=new Date(1e3*t.updatetime);s=r.getHours()+":"+("0"+r.getMinutes()).substr(-2)}var i=a[1],o=0===a[0],l="string"==typeof i&&!o;i=o?"Closed":i,document.querySelector(".place-modal__title").innerHTML=t.name,document.querySelector(".place-modal__subtitle").innerHTML=t.address;var c=document.querySelector(".place-modal__badge div"),d=o?"Closed":i+" min";d=l?"No info":d,c.setAttribute("class","text-center bg-"+i.toString().toLowerCase()+"min"),document.querySelector("#time-min").innerHTML=d,document.querySelector("#place-modal time").innerHTML=s,document.querySelector("#time-range").value="string"==typeof a[1]?10:a[1],n.addEventListener("keyup",function(e){console.log(e);"Escape"===e.key&&Utils.closeModal("place-modal")}),n.classList.add("show"),n.focus()},hidePlaceModal:function(e){e=e||!1;var t=document.getElementById("place-modal");if(t.classList.remove("show"),e){var a={place_id:t.getAttribute("data-place-id"),value:{estimate_person:0,estimate_wait_min:parseInt(document.querySelector("#time-range").value)}};Utils.sendFeedback(a);var n=TimesApp.menuPlaces[t.getAttribute("data-place-id")].data;n.user_feedback=a,n.user_feedback.estimate_wait_min=a.value.estimate_wait_min,n.user_feedback.updatetime=(new Date).getTime()/1e3,TimesApp.setPlaceOnMap([n]),null!==document.querySelector(".sidebar.show")&&Utils.showPlaceSidebar()}},openSuggestModal:function(){null!==document.querySelector(".modal")&&document.body.removeChild(document.querySelector(".modal")),Utils.openModal("suggest-modal","Search by address",'<input type="text" autocomplete="off" name="suggest-adr" onkeydown="Utils.searchSuggest(this)" placeholder="Insert your city or address" id="suggest-input"><div id="suggest-results"></div>',"Search",function(){if(""==document.getElementById("suggest-input").value)return alert("Please, specify a place name and a place address."),!1;TimesApp.address=document.getElementById("suggest-input").value,TimesApp.search(-1),document.body.removeChild(document.querySelector(".modal"))}),document.getElementById("suggest-input").focus()},searchByNameModal:function(){null!==document.querySelector(".modal")&&document.body.removeChild(document.querySelector(".modal")),Utils.openModal("search-modal","Search by name and address",'<input type="text" placeholder="Insert market or place name" id="place"><input type="text" placeholder="Insert address or city" id="address">',"Search",function(){if(""==document.getElementById("place").value||""==document.getElementById("address").value)return alert("Please, specify a place name and a place address."),!1;TimesApp.getPlace(document.getElementById("place").value,document.getElementById("address").value),document.body.removeChild(document.querySelector(".modal"))})},openModal:function(e,t,a,n,s,r){e=e||(new Date).getTime();var i=t,o=(n=n||"Send",document.createElement("div"));o.id=e,o.className="modal show",o.tabIndex="-1",o.setAttribute("role","dialog"),o.setAttribute("aria-label",t),o.setAttribute("aria-modal","true"),o.addEventListener("keyup",function(t){"Escape"===t.key&&Utils.closeModal(e)});var l=document.createElement("div");l.className="modal-content animate-opacity card-4",o.appendChild(l);var c=document.createElement("div");c.className="container teal",l.appendChild(c);var d=document.createElement("div");d.className="container",l.appendChild(d),d.innerHTML=a||CONTENT_CONSTANTS.HELP_MODAL.BODY;var p=document.createElement("button");p.setAttribute("type","button"),p.className="close-button display-topright",p.setAttribute("onclick","Utils.closeModal('"+e+"')"),p.innerHTML="&times; <span class='sr-only'>Close"+t+" modal</span>",c.appendChild(p);var u=document.createElement("H2");u.innerHTML=i,c.appendChild(u);var m=document.createElement("div");m.className="container teal",l.appendChild(m);var g=document.createElement("button");if(g.setAttribute("type","button"),g.className="btn",-1!==n&&(g.style.float="right"),void 0===r?g.setAttribute("onclick","Utils.closeModal('"+e+"')"):g.addEventListener("click",r),g.innerHTML="Close",m.appendChild(g),-1!==n){var f=document.createElement("button");f.setAttribute("type","button"),f.className="btn",void 0===s?f.setAttribute("onclick","TimesApp.sendHelp(document.querySelector('.modal-content textarea').value, document.querySelector('.modal-content #email').value)"):f.addEventListener("click",s),f.innerHTML=n,m.appendChild(f)}document.getElementsByTagName("body")[0].appendChild(o),o.focus()},closeModal:function(e){document.getElementById(e).classList.remove("show")},getAccurateCurrentPosition:function(e,t,a,n){var s,r,i,o=0,l=function(t){e(t)};(n=n||{}).maxWait||(n.maxWait=1e4),n.desiredAccuracy||(n.desiredAccuracy=20),n.timeout||(n.timeout=n.maxWait),n.maximumAge=0,n.enableHighAccuracy=!0,r=navigator.geolocation.watchPosition(function(e){s=e,o+=1,e.coords.accuracy<=n.desiredAccuracy&&o>1?(clearTimeout(i),navigator.geolocation.clearWatch(r),l(e)):a(e)},function(e){clearTimeout(i),navigator.geolocation.clearWatch(r),t(e)},n),i=setTimeout(function(){navigator.geolocation.clearWatch(r),l(s)},n.maxWait)},destinationPoint:function(e,t,a,n){n/=6371,a=a.toRad();var s=e.toRad(),r=t.toRad(),i=Math.asin(Math.sin(s)*Math.cos(n)+Math.cos(s)*Math.sin(n)*Math.cos(a)),o=r+Math.atan2(Math.sin(a)*Math.sin(n)*Math.cos(s),Math.cos(n)-Math.sin(s)*Math.sin(i));return isNaN(i)||isNaN(o)?null:[i.toDeg(),o.toDeg()]},toggleLegend:function(e){"none"==document.getElementById("legend-values").style.display?(document.getElementById("legend-values").style.display="block",e.innerHTML="Legend ‚ñæ"):(document.getElementById("legend-values").style.display="none",e.innerHTML="Legend ‚ñ¥")},distanceLatLng:function(e,t,a,n){var s=(a-e).toRad(),r=(n-t).toRad(),i=(e=e.toRad(),a=a.toRad(),Math.sin(s/2)*Math.sin(s/2)+Math.sin(r/2)*Math.sin(r/2)*Math.cos(e)*Math.cos(a));return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}},last_address=localStorage.getItem("last_address"),last_lat=localStorage.getItem("last_lat"),last_lng=localStorage.getItem("last_lng"),TimesApp={startBoundIndex:361,mapMarkers:{},menuPlaces:{},address:null!==last_address?last_address:"Firenze",lat:null!==last_lat?parseFloat(last_lat):43.7740236,lng:null!==last_lng?parseFloat(last_lng):11.253233,zoom:15,lMap:null,myPosition:null,query:"supermarket",isLoading:!1,place_ids:[],icons:[],fullEstimation:!0,setLoading:function(e){TimesApp.isLoading=e;var t=!0===e?"block":"none";document.getElementById("top-progress-bar").style.display=t},initIcon:function(){var e=["0","1","2","3","4","5","6","7","8"];for(var t in e)TimesApp.icons.push(L.icon({iconUrl:"/assets/custom-marker/"+e[t]+".png",iconSize:[42,42],iconAnchor:[20,32],popupAnchor:[2,-20]}))},initMap:function(e){e=e||!0;TimesApp.initIcon(),TimesApp.lMap=L.map("full-map").setView([TimesApp.lat,TimesApp.lng],TimesApp.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:11,attribution:'Map data <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'}).addTo(TimesApp.lMap),TimesApp.myPosition=L.circle([TimesApp.lat,TimesApp.lng],{color:"#0696c1",fillColor:"#06aee0",fillOpacity:.5,radius:50}).bindPopup("Your position").addTo(TimesApp.lMap),TimesApp.lMap.on("moveend zoomend",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:clearTimeout(Utils.updateTimeout),a=TimesApp.lMap.getCenter(),console.log("new center ",a.toString()),console.log(t.type),(Utils.distanceLatLng(TimesApp.lat,TimesApp.lng,a.lat,a.lng)>=2.5||"zoomend"==t.type)&&(Utils.updateTimeout=setTimeout(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return TimesApp.lat=parseFloat(a.lat),TimesApp.lng=parseFloat(a.lng),e.next=4,TimesApp.updateAddress(-1);case 4:return TimesApp.getPlaces(null,!0),e.next=7,TimesApp.updateBound(TimesApp.lat,TimesApp.lng);case 7:TimesApp.getPharmacies(),localStorage.setItem("last_address",TimesApp.address),localStorage.setItem("last_lat",TimesApp.lat),localStorage.setItem("last_lng",TimesApp.lng);case 11:case"end":return e.stop()}},e)})),1e3));case 5:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()),TimesApp.showLegend(),!0===e&&TimesApp.getPlaces(null,!0)},getMarkerPlaceColor:function(e){return e>60?[6,"#cc0c33"]:e>45?[5,"#ff2929"]:e>30?[4,"#fa4c25"]:e>25?[3,"#fc7e2a"]:e>15?[2,"#ffbf1c"]:e>10?[1,"#ecf716"]:[0,"#1fcc00"]},showLegend:function(){var e=L.control({position:"bottomleft"});e.onAdd=function(e){var t,a,n=L.DomUtil.create("div","info legend"),s=[5,10,15,25,30,45,60],r=[];r.push('<i style="background: #3f8ee2"></i> No info');for(var i=0;i<s.length;i++)t=s[i],a=s[i+1],r.push('<i style="background:'+TimesApp.getMarkerPlaceColor(s[i]+1)[1]+'"></i> '+t+(a?"&ndash;"+a:"+"));return n.innerHTML='<span onclick="Utils.toggleLegend(this)">Legend ‚ñ¥</span><div style="display: none" id="legend-values"><u>Minutes</u>:<br>'+r.join("<br>")+"</div>",n},e.addTo(TimesApp.lMap)},getWaitTime:function(e){var t=(new Date).getHours(),a=0===(new Date).getDay()?6:(new Date).getDay()-1,n=0,s=0,r=0;void 0!==e.time_spent&&e.time_spent.length>0&&(e.time_spent[0]=1==e.time_spent[0]?60:e.time_spent[0],e.time_spent[1]=1==e.time_spent[1]?60:e.time_spent[1],n=Math.max.apply(Math,_toConsumableArray(e.time_spent)),r=Math.min.apply(Math,_toConsumableArray(e.time_spent)),s=e.time_spent.reduce(function(e,t){return e+t},0)/2);var i=e.current_popularity||0,o=0,l=0,c=1;void 0!==e.time_wait&&e.time_wait.length>0&&(o=e.time_wait[a].data[t]),void 0!==e.populartimes&&(c=l=e.populartimes[a].data[t],(new Date).getMinutes()>=40&&void 0!==e.populartimes[a].data[t+1]&&0!=e.populartimes[a].data[t+1]&&(l=Math.floor((l+e.populartimes[a].data[t+1])/2)));var d=0,p=l-i,u=l>0?s:0;0!==i?l/i<=3.3?p<=0&&m>10?u=n+5*Math.ceil(i/2/5):p>0&&p<l/5?u=s:p>=l/5&&p<=l/2.9?u=r:p>l/2.9&&p<=l/1.8?u=5*Math.ceil(r/2/5):p>l/1.8&&p<=l/1.5?u=5*Math.ceil(r/3/5):p>l/1.5&&(u=0,o=5*Math.ceil(20*o/100/5)):i>=l/3.3?u=r:(o=0,u=5):0==o?u=0:0==i&&0==TimesApp.fullEstimation&&(m=0,u=0),d+=u;var m=5*Math.ceil((o+d)/5);return 0!==l&&i>=18&&(m+=5),0!==m||0!==s&&0!==i||(m="No information about "),[c,m]},getPharmacies:function(){console.log("Getting pharmacy")},getPlace:function(e,t){TimesApp.setLoading(!0);var a=WaitingTimesAPI.format(WaitingTimesAPI.getPlaceByNameAPI,e,t);ga("send","event","Request","Place",e+" "+t),fetch(a).then(function(e){if(e.ok)return e.json()}).then(function(e){TimesApp.setLoading(!1),void 0!==e[0].place_id&&null!==e[0].coordinates.lat?(TimesApp.setPlaceOnMap(e),TimesApp.lMap.setView([e[0].coordinates.lat,e[0].coordinates.lng],TimesApp.zoom),TimesApp.mapMarkers[e[0].place_id].fireEvent("click")):alert("You need to specify the full address of a place.")}).catch(function(e){return Utils.sendError({url:a,singlePlace:!0,message:e.toString()})})},getPlacesFallback:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPI.replace("api-geo-fr","api-geo-uk").replace("api-geo-ny","api-geo-uk"),TimesApp.query,TimesApp.address),ga("send","event","Request","Places",TimesApp.address),fetch(t).then(function(e){if(e.ok)return e.json()}).then(function(e){return TimesApp.setPlaceOnMap(e)}).catch(function(e){return Utils.sendError({url:t,message:e.toString()})});case 3:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),getPlaces:function(e,t){e=e||TimesApp.query,t=t||!1;if(TimesApp.setLoading(!0),t){var a=new Headers;a.append("x-geo-lat",TimesApp.lat),a.append("x-geo-lng",TimesApp.lng);var n=WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPIFallback,e,TimesApp.address);ga("send","event","Request","Places",TimesApp.address),fetch(n,{headers:a}).then(function(e){if(e.ok)return e.json()}).then(function(e){TimesApp.startBoundIndex=e.length<=40?120:361,TimesApp.setPlaceOnMap(e),TimesApp.updateBound(TimesApp.lat,TimesApp.lng)}).catch(function(e){return TimesApp.getPlacesFallback()})}else{var s=WaitingTimesAPI.getPlacesAPI,r=WaitingTimesAPI.format(s,e,TimesApp.address);ga("send","event","Request","Places",TimesApp.address),fetch(r).then(function(e){if(e.ok)return e.json()}).then(function(e){return TimesApp.setPlaceOnMap(e)}).catch(function(e){return TimesApp.getPlacesFallback()})}},setPlaceOnMap:function(e){console.log(e),TimesApp.setLoading(!1);var t=[],a={};TimesApp.menuPlaces>=140&&(TimesApp.menuPlaces={});var n=function(n){r=TimesApp.getWaitTime(e[n]),i=r[1],o=TimesApp.getMarkerPlaceColor(i),l="<b>"+e[n].name+"</b><br><small>"+e[n].address+"</small><br/><i>"+i+"min</i> of line",0===r[0]&&(o=["7","#777"],l="<i>Closed</i><br/>"+l),void 0!==e[n].user_feedback&&void 0!==e[n].user_feedback.estimate_wait_min&&(i=e[n].user_feedback.estimate_wait_min,r[1]=i,o=TimesApp.getMarkerPlaceColor(i),e[n].updatetime=e[n].user_feedback.updatetime),void 0!==e[n].updatetime&&(c=new Date(1e3*e[n].updatetime),d=c.getHours(),p="0"+c.getMinutes(),u=d+":"+p.substr(-2),l+=" - <i>Last update at</i> "+u),m="string"==typeof i&&"7"!=o[0]?TimesApp.icons[8]:TimesApp.icons[o[0]];var s=L.marker([e[n].coordinates.lat,e[n].coordinates.lng],{icon:m});-1!==TimesApp.place_ids.indexOf(e[n].place_id)&&(TimesApp.mapMarkers[e[n].place_id].setIcon(m),TimesApp.mapMarkers[e[n].place_id].removeEventListener("click"),TimesApp.menuPlaces[e[n].place_id]={data:e[n],waitTimeArr:r}),s.addTo(TimesApp.lMap).on("click",function(){Utils.showPlaceModal(e[n].place_id)}),t.push(s),a[e[n].place_id]={data:e[n],waitTimeArr:r},TimesApp.mapMarkers[e[n].place_id]=s,TimesApp.place_ids.push(e[n].place_id)};for(var s in e){var r,i,o,l,c,d,p,u,m;n(s)}return Object.keys(a).length>0&&(TimesApp.menuPlaces=Object.assign(a,TimesApp.menuPlaces)),t},updateAddressAwait:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI,TimesApp.lat,TimesApp.lng));case 2:if(!(t=e.sent).ok){e.next=9;break}return e.next=6,t.json();case 6:e.t0=e.sent,e.next=10;break;case 9:e.t0={staddress:"",city:""};case 10:(t=e.t0).staddress="object"===_typeof(t.staddress)||void 0===t.staddress?"":t.staddress,t.city="object"===_typeof(t.city)||void 0===t.city?"":t.city,TimesApp.address=""!==t.staddress?t.staddress+", ":"",TimesApp.address+=t.city,TimesApp.getPlaces(),ga("send","event","Request","Geocode",WaitingTimesAPI.geocodeAPI);case 17:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),updateAddress:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,n,s,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPIClient,TimesApp.lng,TimesApp.lat),a=1,5==Math.floor(15*Math.random())&&(a=0,t=WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI,TimesApp.lat,TimesApp.lng)),e.next=5,fetch(t);case 5:if(n=e.sent,s={staddress:"",city:""},!n.ok){e.next=13;break}return e.next=10,n.json();case 10:s=e.sent,e.next=18;break;case 13:return e.next=15,n.json();case 15:return r=e.sent,Utils.sendError({url:t,updateAddress:!0,message:r.toString()}),e.abrupt("return",!1);case 18:s.staddress="object"===_typeof(s.staddress)||void 0===s.staddress?"":s.staddress,s.city="object"===_typeof(s.city)||void 0===s.city?"":s.city,""===s.staddress&&void 0!==s.address&&(s.staddress=void 0===s.address.Address?"":s.address.Address),""===s.city&&void 0!==s.address&&(s.city=void 0===s.address.City?"":s.address.City),TimesApp.address=""!==s.staddress?s.staddress+", ":"",TimesApp.address+=s.city,TimesApp.getPlaces(null,!0),ga("send","event","Request","Geocode",0==a?WaitingTimesAPI.geocodeAPI:WaitingTimesAPI.geocodeAPIClient);case 26:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),updateBound:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,a){var n,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:TimesApp.setLoading(!0),n=361;case 2:if(!(n<=360)){e.next=13;break}return s=Utils.destinationPoint(t,a,n,2.5),TimesApp.lat=parseFloat(s[0]),TimesApp.lng=parseFloat(s[1]),e.next=8,new Promise(function(e){return setTimeout(e,3e3)});case 8:return e.next=10,TimesApp.updateAddress(-1);case 10:n+=120,e.next=2;break;case 13:TimesApp.setLoading(!1);case 14:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}(),geoSuccess:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==t){e.next=3;break}return TimesApp.geoError(),e.abrupt("return",!1);case 3:return TimesApp.toggleSpinner(),TimesApp.lat=parseFloat(t.coords.latitude),TimesApp.lng=parseFloat(t.coords.longitude),TimesApp.lMap.setView([TimesApp.lat,TimesApp.lng],TimesApp.zoom),e.next=9,TimesApp.updateAddress();case 9:return e.next=11,TimesApp.updateBound(TimesApp.lat,TimesApp.lng);case 11:ga("send","event","Geolocation","GeoSuccess","true");case 12:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),showModalHelp:function(){null!==document.querySelector(".modal")&&document.body.removeChild(document.querySelector(".modal")),Utils.openModal("help-modal","Need help? Do you want to ask something?")},sendReview:function(e){e=e||"0";ga("send","event","Review","Rate",e),Utils.sendError({rate:e}),localStorage.setItem("sended_review","yes"),document.querySelector(".modal-content div.container").innerHTML="<h2>Feedback sent, thank you!</h2>",setTimeout(function(){document.body.removeChild(document.getElementById("rating-modal"))},1200)},sendHelp:function(e,t){t=t||"";""!=e&&""!=t&&Utils.sendError({message:e,email:t,help:!0}),document.querySelector(".modal-content div.container").innerHTML="<h2>Message sent, thank you!</h2>",setTimeout(function(){Utils.closeModal("help-modal")},1200)},fallbackGeocodeCall:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var a,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(WaitingTimesAPI.format(WaitingTimesAPI.fallbackGeocodeAPI,t));case 2:return a=e.sent,e.next=5,a.json();case 5:return void 0!==(n=e.sent).candidates&&n.candidates.length>0?(n.latt=n.candidates[0].location.y,n.longt=n.candidates[0].location.x):n.error=!0,e.abrupt("return",n);case 8:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),search:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var a,n,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!0===(t=t||!0)&&(TimesApp.address=prompt("This app need your gps position or at least your address or your city:","")),null!==TimesApp.address){e.next=4;break}return e.abrupt("return",!1);case 4:if(TimesApp.setLoading(!0),""==TimesApp.address){e.next=26;break}return ga("send","event","Request","Search",TimesApp.address),a="https://geocode.xyz/"+TimesApp.address+"?json=1",e.next=10,fetch(a);case 10:return n=e.sent,e.next=13,n.json();case 13:if(s=e.sent,n.ok&&(void 0===s.error||"006"!==s.error.code)){e.next=18;break}return e.next=17,TimesApp.fallbackGeocodeCall(TimesApp.address);case 17:s=e.sent;case 18:if(void 0===s.error){e.next=21;break}return setTimeout(function(){alert("No results. Check your address/city and try again. Please write the city in english"),Utils.sendError({url:a,search:!0,message:s.error}),Utils.openSuggestModal()},2e3),e.abrupt("return",!1);case 21:TimesApp.lat=parseFloat(s.latt),TimesApp.lng=parseFloat(s.longt),TimesApp.getPlaces(null,!0),TimesApp.lMap.setView([TimesApp.lat,TimesApp.lng],TimesApp.zoom),TimesApp.updateBound(TimesApp.lat,TimesApp.lng);case 26:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),promptAddress:function(){return prompt("This app need your gps position or at least your address or your city:","")},geoError:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:TimesApp.toggleSpinner(),Utils.openSuggestModal();case 2:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),initGeodata:function(){TimesApp.toggleSpinner(),Utils.getAccurateCurrentPosition(TimesApp.geoSuccess,TimesApp.geoError,function(e){console.log(e)},{desiredAccuracy:100,maxWait:8e3})},toggleSpinner:function(){var e=document.getElementById("loading"),t="block";"block"==e.style.display&&(t="none"),e.style.display=t}};document.addEventListener("DOMContentLoaded",function(){document.getElementById("full-map").style.height=window.innerHeight+"px",TimesApp.initMap(-1),Utils.shouldShowWelcomeModal()?Utils.showWelcomeModal():null===last_address?TimesApp.initGeodata():TimesApp.getPlaces(null,!0),setTimeout(function(){TimesApp.getPlaces(null,!0)},3e5),"yes"!==localStorage.getItem("sended_review")&&false==true&&setTimeout(function(){Utils.openModal("rating-modal","Please, take time to rate this project",'\n        <h4>Your feedback is very important to understand if the estimates are correct or not. Together we can build something useful!</h4>\n        <div class="rate">\n          <input type="radio" id="star5" name="rate" value="5">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star5" data-value="5" title="5 stars"><span class=\'sr-only\'>5 stars</span></label>\n          <input type="radio" id="star4" name="rate" value="4">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star4" data-value="4" title="4 stars"><span class=\'sr-only\'>4 stars</span></label>\n          <input type="radio" id="star3" name="rate" value="3">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star3" data-value="3" title="3 stars"><span class=\'sr-only\'>3 stars</span></label>\n          <input type="radio" id="star2" name="rate" value="2">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star2" data-value="2" title="2 stars"><span class=\'sr-only\'>2 stars</span></label>\n          <input type="radio" id="star1" name="rate" value="1">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star1" data-value="1" title="1 star"><span class=\'sr-only\'>1 star</span></label>\n        </div>\n      ',-1)},12e4)}),window.onerror=function(e,t,a){var n={date:(new Date).toString(),ua:navigator.userAgent,errorMessage:e,errorUrl:t,errorLine:a};Utils.sendError(n)},window.addEventListener("appinstalled",function(){ga("send","event","PWA","Installed","true"),Utils.sendError({pwa_installed:!0})}),function(e,t,a,n,s,r,i){e.GoogleAnalyticsObject=s,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,r=t.createElement(a),i=t.getElementsByTagName(a)[0],r.async=1,r.src="//www.google-analytics.com/analytics.js",i.parentNode.insertBefore(r,i)}(window,document,"script",0,"ga"),ga("create","UA-10999521-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");try{navigator.serviceWorker.register("/sw.js")}catch(e){console.log(e)}