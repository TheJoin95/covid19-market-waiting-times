const API_DOMAIN_AVAILABLE=["api-geo","api-geo","api-geo-fr"],API_DOMAIN=API_DOMAIN_AVAILABLE[Math.floor(Math.random()*API_DOMAIN_AVAILABLE.length)],WaitingTimesAPI={geocodeAPI:"https://"+API_DOMAIN+".thejoin.tech/geocode?lat=%s&lng=%s",logAPI:"https://api-geo.thejoin.tech/logger",getPlaceByNameAPI:"https://api-geo.thejoin.tech/places/get-by-name?q=%s&address=%s",getPlacesAPI:"https://api-geo-fr.thejoin.tech/places/explore?q=%s&address=%s&lat=%s&lng=%s",format:function(e){var t=[].slice.call(arguments,1),a=0;return e.replace(/%s/g,()=>t[a++])}};Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return 180*this/Math.PI};const Utils={updateTimeout:null,geoErrorTimeout:null,geoErrorFailOverCount:0,sendError:function(e){e.ua=navigator.userAgent,e.date=(new Date).toString(),fetch(WaitingTimesAPI.logAPI,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)})},searchByNameModal:function(){document.body.removeChild(document.querySelector(".modal")),Utils.openModal("search-modal","Search by name and address",'<input type="text" placeholder="Insert market or place name" id="place"><input type="text" placeholder="Insert address or city" id="address">',"Search",function(){TimesApp.getPlace(document.getElementById("place").value,document.getElementById("address").value),document.body.removeChild(document.querySelector(".modal"))})},openModal:function(e,t,a,s,i,n){e=e||(new Date).getTime();var o=t,r=(s=s||"Send",document.createElement("div"));r.id=e,r.className="modal";var p=document.createElement("div");p.className="modal-content animate-opacity card-4",r.appendChild(p);var l=document.createElement("header");l.className="container teal",p.appendChild(l);var c=document.createElement("div");c.className="container",p.appendChild(c),c.innerHTML=a||'<p>Did not find what you were looking for? <u style="cursor: pointer" onclick="Utils.searchByNameModal()">Search by name</u></p><textarea placeholder="Write here your question or tips" rows="7"></textarea><small><i>Note: this is not a search box</i></small>';var d=document.createElement("span");d.className="close-button display-topright",d.setAttribute("onclick","document.getElementById('"+e+"').style.display='none'"),d.innerHTML="&times;",l.appendChild(d);var m=document.createElement("H2");m.innerHTML=o,l.appendChild(m);var u=document.createElement("footer");u.className="container teal",p.appendChild(u);var g=document.createElement("span");g.className="btn",g.style.float="right",n===undefined?g.setAttribute("onclick","document.getElementById('"+e+"').style.display='none'"):g.addEventListener("click",n),g.innerHTML="Close",u.appendChild(g);var A=document.createElement("span");A.className="btn",i===undefined?A.setAttribute("onclick","TimesApp.sendHelp(document.querySelector('.modal-content textarea').value)"):A.addEventListener("click",i),A.innerHTML=s,u.appendChild(A),r.style.display="block",document.getElementsByTagName("body")[0].appendChild(r)},getAccurateCurrentPosition:function(e,t,a,s){var i,n,o,r=0,p=function(t){e(t)};(s=s||{}).maxWait||(s.maxWait=1e4),s.desiredAccuracy||(s.desiredAccuracy=20),s.timeout||(s.timeout=s.maxWait),s.maximumAge=0,s.enableHighAccuracy=!0,n=navigator.geolocation.watchPosition(function(e){i=e,r+=1,e.coords.accuracy<=s.desiredAccuracy&&r>1?(clearTimeout(o),navigator.geolocation.clearWatch(n),p(e)):a(e)},function(e){clearTimeout(o),navigator.geolocation.clearWatch(n),t(e)},s),o=setTimeout(function(){navigator.geolocation.clearWatch(n),p(i)},s.maxWait)},destinationPoint:function(e,t,a,s){s/=6371,a=a.toRad();var i=e.toRad(),n=t.toRad(),o=Math.asin(Math.sin(i)*Math.cos(s)+Math.cos(i)*Math.sin(s)*Math.cos(a)),r=n+Math.atan2(Math.sin(a)*Math.sin(s)*Math.cos(i),Math.cos(s)-Math.sin(i)*Math.sin(o));return isNaN(o)||isNaN(r)?null:[o.toDeg(),r.toDeg()]},distanceLatLng:function(e,t,a,s){var i=(a-e).toRad(),n=(s-t).toRad(),o=(e=e.toRad(),a=a.toRad(),Math.sin(i/2)*Math.sin(i/2)+Math.sin(n/2)*Math.sin(n/2)*Math.cos(e)*Math.cos(a));return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}},TimesApp={lat:null,lng:null,address:"",zoom:15,lMap:null,myPosition:null,query:"supermarket",isLoading:!1,place_ids:[],icons:[],setLoading:function(e){TimesApp.isLoading=e;var t=!0===e?"block":"none";document.getElementById("top-progress-bar").style.display=t},initIcon:function(){const e=["0","1","2","3","4","5","6","7"];for(const t in e)TimesApp.icons.push(L.icon({iconUrl:"/assets/custom-marker/"+e[t]+".png",iconSize:[42,42],iconAnchor:[20,32],popupAnchor:[2,-20]}))},initMap:function(){TimesApp.toggleSpinner(),TimesApp.initIcon(),TimesApp.lMap=L.map("full-map").setView([TimesApp.lat,TimesApp.lng],TimesApp.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:14,attribution:'Map data <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'}).addTo(TimesApp.lMap),TimesApp.lMap.zoomControl.remove(),TimesApp.myPosition=L.circle([TimesApp.lat,TimesApp.lng],{color:"#0696c1",fillColor:"#06aee0",fillOpacity:.5,radius:50}).bindPopup("Your position").addTo(TimesApp.lMap),TimesApp.lMap.on("moveend",async function(){clearTimeout(Utils.updateTimeout);let e=TimesApp.lMap.getCenter();console.log("new center ",e.toString()),Utils.distanceLatLng(TimesApp.lat,TimesApp.lng,e.lat,e.lng)>=2&&(TimesApp.lat=parseFloat(e.lat),TimesApp.lng=parseFloat(e.lng),Utils.updateTimeout=setTimeout(async function(){await TimesApp.updateAddress(-1),await TimesApp.updateBound(TimesApp.lat,TimesApp.lng)},1e3),TimesApp.getPharmacies())}),TimesApp.showLegend(),TimesApp.getPlaces()},getMarkerPlaceColor:function(e){return e>60?[6,"#cc0c33"]:e>45?[5,"#ff2929"]:e>30?[4,"#fa4c25"]:e>25?[3,"#fc7e2a"]:e>15?[2,"#ffbf1c"]:e>10?[1,"#ecf716"]:[0,"#1fcc00"]},showLegend:function(){var e=L.control({position:"bottomright"});e.onAdd=function(e){for(var t,a,s=L.DomUtil.create("div","info legend"),i=[5,10,15,25,30,45,60],n=[],o=0;o<i.length;o++)t=i[o],a=i[o+1],n.push('<i style="background:'+TimesApp.getMarkerPlaceColor(i[o]+1)[1]+'"></i> '+t+(a?"&ndash;"+a:"+"));return s.innerHTML="Minutes:<br>"+n.join("<br>"),s},e.addTo(TimesApp.lMap)},getWaitTime:function(e){const t=(new Date).getHours(),a=0===(new Date).getDay()?6:(new Date).getDay()-1;var s,i,n=0;e.time_spent!==undefined&&e.time_spent.length>0&&(e.time_spent[0]=1==e.time_spent[0]?60:e.time_spent[0],e.time_spent[1]=1==e.time_spent[1]?60:e.time_spent[1],s=Math.max(...e.time_spent),n=Math.min(...e.time_spent),i=e.time_spent.reduce(function(e,t){return e+t},0)/2);const o=e.current_popularity||0;var r=popTimes=0;e.time_wait!==undefined&&e.time_wait.length>0&&(r=e.time_wait[a].data[t]),popTimes=e.populartimes[a].data[t];var p=0;const l=popTimes-o;var c=0;0!==o&&o>15&&(l<0?c=s:l>=0&&l<5?c=i:l>=5&&l<popTimes/2?c=n:l>=popTimes/2&&(c=5)),p+=c;var d=Math.ceil(r+p);return 0!==popTimes&&o>=15&&(d+=5),[e.populartimes[a].data[t],d]},getPharmacies:function(){console.log("Getting pharmacy"),TimesApp.getPlaces("pharmacy")},getPlace:function(e,t){TimesApp.setLoading(!0);const a=WaitingTimesAPI.format(WaitingTimesAPI.getPlaceByNameAPI,e,t);fetch(a).then(e=>{if(e.ok)return e.json()}).then(t=>{const a=TimesApp.setPlaceOnMap(t);a.length>0?a[a.length-1].openPopup():alert("Unfortunally "+e+" does not have any information about waiting times")})["catch"](e=>Utils.sendError({url:a,message:e.toString()}))},getPlaces:function(e){e=e||TimesApp.query,TimesApp.setLoading(!0);const t=WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPI,e,TimesApp.address,TimesApp.lat,TimesApp.lng);fetch(t).then(e=>{if(e.ok)return e.json()}).then(e=>TimesApp.setPlaceOnMap(e))["catch"](e=>Utils.sendError({url:t,message:e.toString()}))},setPlaceOnMap:function(e){console.log(e),TimesApp.setLoading(!1);var t=[];for(const a in e){if(e[a].populartimes===undefined||-1!==TimesApp.place_ids.indexOf(e[a].place_id))continue;let s=TimesApp.getWaitTime(e[a]),i=s[1],n=i+80,o=TimesApp.getMarkerPlaceColor(i),r="<b>"+e[a].name+"</b><br><small>"+e[a].address+"</small><br/><i>"+i+"min</i> of line";isNaN(n)&&(n=80),0===s[0]&&(o=["7","#777"],n=80,r="<i>Closed</i><br/>"+r);const p=L.marker([e[a].coordinates.lat,e[a].coordinates.lng],{icon:TimesApp.icons[o[0]]});p.bindPopup(r),p.addTo(TimesApp.lMap),t.push(p),TimesApp.place_ids.push(e[a].place_id)}return t},updateAddressAwait:async function(e){e=e||!0;var t=await fetch(WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI,TimesApp.lat,TimesApp.lng));(t=t.ok?await t.json():{staddress:"",city:""}).staddress="object"==typeof t.staddress||t.staddress===undefined?"":t.staddress,t.city="object"==typeof t.city||t.city===undefined?"":t.city,TimesApp.address=""!==t.staddress?t.staddress+", ":"",TimesApp.address+=t.city,!0===e?TimesApp.initMap():TimesApp.getPlaces()},updateAddress:async function(e){e=e||!0,TimesApp.setLoading(!0);const t=WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI,TimesApp.lat,TimesApp.lng);fetch(t).then(e=>e.ok?e.json():{staddress:"",city:""}).then(t=>{t.staddress="object"==typeof t.staddress||t.staddress===undefined?"":t.staddress,t.city="object"==typeof t.city||t.city===undefined?"":t.city,TimesApp.address=""!==t.staddress?t.staddress+", ":"",TimesApp.address+=t.city,!0===e?TimesApp.initMap():TimesApp.getPlaces()})["catch"](e=>Utils.sendError({url:t,message:e.toString()}))},updateBound:async function(e,t){TimesApp.setLoading(!0);for(var a=0;a<=360;a+=90){let s=Utils.destinationPoint(e,t,a,2.5);TimesApp.lat=parseFloat(s[0]),TimesApp.lng=parseFloat(s[1]),await new Promise(e=>setTimeout(e,3e3)),await TimesApp.updateAddress(-1)}},geoSuccess:async function(e){if(e===undefined)return TimesApp.geoError(),!1;TimesApp.lat=parseFloat(e.coords.latitude),TimesApp.lng=parseFloat(e.coords.longitude),await TimesApp.updateAddressAwait(),await TimesApp.updateBound(TimesApp.lat,TimesApp.lng)},showModalHelp:function(){null!==document.querySelector(".modal")&&document.body.removeChild(document.querySelector(".modal")),Utils.openModal("help-modal","Need help? Do you want to ask something?")},sendHelp:function(e){Utils.sendError({message:e,help:!0}),document.querySelector(".modal-content div.container").innerHTML="<h2>Message sent, thank you!</h2>",setTimeout(function(){document.getElementById("help-modal").style.display="none"},1200)},search:async function(){if(TimesApp.address=prompt("This app need your gps position or at least your address or your city:",""),TimesApp.setLoading(!0),null===TimesApp.address)return!1;if(""!=TimesApp.address){const e="https://geocode.xyz/"+TimesApp.address+"?json=1";fetch(e).then(e=>e.json()).then(t=>{if(t.error!==undefined)return alert("No results. Check your address/city and try again. Please write the city in english"),Utils.sendError({url:e,message:t.error}),TimesApp.search(),!1;TimesApp.getPlaces(),TimesApp.lat=parseFloat(t.latt),TimesApp.lng=parseFloat(t.longt),TimesApp.lMap.setView([TimesApp.lat,TimesApp.lng],TimesApp.zoom),TimesApp.updateBound(TimesApp.lat,TimesApp.lng)})["catch"](t=>Utils.sendError({url:e,message:t.toString()}))}},promptAddress:function(){return prompt("This app need your gps position or at least your address or your city:","")},geoError:function(e){if(clearTimeout(Utils.geoErrorTimeout),TimesApp.address=TimesApp.promptAddress(),null===TimesApp.address?(Utils.geoErrorFailOverCount+=1,TimesApp.lat=43.7740236,TimesApp.lng=11.253233,TimesApp.address="Firenze",null===TimesApp.lMap&&TimesApp.initMap(),Utils.geoErrorFailOverCount<2&&(Utils.geoErrorTimeout=setTimeout(function(){TimesApp.geoError()},1e3))):TimesApp.address=TimesApp.address.trim(),""!=TimesApp.address){const e="https://geocode.xyz/"+TimesApp.address+"?json=1";fetch(e).then(e=>e.json()).then(t=>{if(t.error!==undefined)return alert("No results. Check your address/city and try again. Please write the city in english"),Utils.sendError({url:e,message:t.error}),TimesApp.geoError(),!1;TimesApp.lat=parseFloat(t.latt),TimesApp.lng=parseFloat(t.longt),null===TimesApp.lMap?(TimesApp.initMap(),TimesApp.updateBound(TimesApp.lat,TimesApp.lng)):(TimesApp.getPlaces(),TimesApp.updateBound(TimesApp.lat,TimesApp.lng))})["catch"](t=>Utils.sendError({url:e,message:t.toString()}))}},toggleSpinner:function(){const e=document.getElementById("loading");let t="block";"block"==e.style.display&&(t="none"),e.style.display=t}};window.onerror=function(e,t,a){const s={date:(new Date).toString(),ua:navigator.userAgent,errorMessage:e,errorUrl:t,errorLine:a};Utils.sendError(s)},document.addEventListener("DOMContentLoaded",function(){document.getElementById("full-map").style.height=window.innerHeight-50+"px",TimesApp.toggleSpinner(),Utils.getAccurateCurrentPosition(TimesApp.geoSuccess,TimesApp.geoError,function(e){console.log(e)},{desiredAccuracy:100,maxWait:8e3})}),function(e,t,a,s,i,n,o){e.GoogleAnalyticsObject=i,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,n=t.createElement(a),o=t.getElementsByTagName(a)[0],n.async=1,n.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(n,o)}(window,document,"script",0,"ga"),ga("create","UA-10999521-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");try{navigator.serviceWorker.register("sw.js")}catch(e){console.log(e)}