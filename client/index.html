<!DOCTYPE html>
<html>
    <head>
        <title>Covid-19 - Supermarket Waiting Times</title>
        <meta name="author" content="https://github.com/TheJoin95/covid19-market-waiting-times/">
        <link rel="icon" type="image/png" href="/assets/icon-resize.png">
        <meta name="description" content="A project to help people stand in line at the market as little as possible" />
        <meta charset="utf-8">
        <link rel="manifest" href="manifest.json">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta property="og:title" content="Covid-19 - Supermarket Waiting Times"/>
        <meta property="og:image" content="https://covid19-waiting-time.thejoin.tech/assets/map.png"/>
        <meta property="og:description" content="A project to help people stand in line at the market as little as possible"/>
        <meta property="og:url" content="https://covid19-waiting-time.thejoin.tech" />
        
        <script data-ad-client="ca-pub-9563589123138123" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!--<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-5221298562415460",
            enable_page_level_ads: true
          });
        </script>-->

        <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>

        <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

        <style>
            html {
                font-family: 'Raleway', sans-serif;
            }

            body {
                margin: 0;
            }

            #full-map {
                width: 100%;
                height: 200px;
            }

            .info {
                padding: 6px 8px;
                font-size: 14px;
                background: rgba(255,255,255,0.8);
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                border-radius: 5px;
            }

            .info h4 {
                margin: 0 0 5px;
                color: #777;
            }

            .legend {
                text-align: left;
                line-height: 18px;
                color: #555;
            }

            .legend i {
                /*width: 18px;*/
                /*height: 18px;*/
                width: 16px;
    						height: 16px;
                float: left;
                margin-right: 8px;
                opacity: 0.7;
            }

            /* SPINNER */
            div#loading {
              position: absolute;
              top: 0;
              left: 0;
              height: 100%;
              width: 100%;
              z-index: 1000;
              background: #9e9e9e61;
            }

            div#loading span {
              text-align: center;
              position: relative;
              top: 50%;
              left: 50%;
              width: 160px;
              display: block;
              margin-top: 0px;
              color: #333;
              margin-left: -80px;
            }

            .sk-chase {
              width: 40px;
              height: 40px;
              position: relative;
              top: 50%;
              left: 50%;
              width: 40px;
              margin-top: -20px;
              margin-left: -20px;
              animation: sk-chase 2.5s infinite linear both;
            }

            .sk-chase-dot {
              width: 100%;
              height: 100%;
              position: absolute;
              left: 0;
              top: 0; 
              animation: sk-chase-dot 2.0s infinite ease-in-out both; 
            }

            .sk-chase-dot:before {
              content: '';
              display: block;
              width: 25%;
              height: 25%;
              background-color: #fff;
              border-radius: 100%;
              animation: sk-chase-dot-before 2.0s infinite ease-in-out both; 
            }

            .sk-chase-dot:nth-child(1) { animation-delay: -1.1s; }
            .sk-chase-dot:nth-child(2) { animation-delay: -1.0s; }
            .sk-chase-dot:nth-child(3) { animation-delay: -0.9s; }
            .sk-chase-dot:nth-child(4) { animation-delay: -0.8s; }
            .sk-chase-dot:nth-child(5) { animation-delay: -0.7s; }
            .sk-chase-dot:nth-child(6) { animation-delay: -0.6s; }
            .sk-chase-dot:nth-child(1):before { animation-delay: -1.1s; }
            .sk-chase-dot:nth-child(2):before { animation-delay: -1.0s; }
            .sk-chase-dot:nth-child(3):before { animation-delay: -0.9s; }
            .sk-chase-dot:nth-child(4):before { animation-delay: -0.8s; }
            .sk-chase-dot:nth-child(5):before { animation-delay: -0.7s; }
            .sk-chase-dot:nth-child(6):before { animation-delay: -0.6s; }

            @keyframes sk-chase {
              100% { transform: rotate(360deg); } 
            }

            @keyframes sk-chase-dot {
              80%, 100% { transform: rotate(360deg); } 
            }

            @keyframes sk-chase-dot-before {
              50% {
                transform: scale(0.4); 
              } 100%, 0% {
                transform: scale(1.0); 
              } 
            }

            @keyframes opac {
                from {
                    opacity: 0
                }

                to {
                    opacity: 1
                }
            }

            /* SPINNER */

            /* MODAL */
            .modal {
                z-index: 100000;
                display: none;
                padding-top: 100px;
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgb(0,0,0);
                background-color: rgba(0,0,0,0.4);
            }
            .animate-opacity {
                animation: opac 0.8s;
            }
            .card-4 {
                box-shadow: 0 4px 10px 0 rgba(0,0,0,0.2), 0 4px 20px 0 rgba(0,0,0,0.19);
            }
            .modal-content {
                margin: auto;
                background-color: #fff;
                position: relative;
                padding: 0;
                outline: 0;
                width: 600px;
                max-width: 100%;
            }
            .modal-content textarea {
                width: 100%;
                margin-top: 10px;
                padding: 5px;
                border: 1px solid #f2f2f2;
                resize: none;
            }
            .teal {
                color: #fff!important;
                background-color: #009688!important;
            }
            .container, .panel {
                padding: 0.01em 16px;
            }
            .display-topright {
                position: absolute;
                right: 0;
                top: 0;
            }
            .close-button {
                border: none;
                font-size: 2.4em;
                display: inline-block;
                padding: 8px 16px;
                vertical-align: middle;
                overflow: hidden;
                text-decoration: none;
                color: inherit;
                background-color: inherit;
                text-align: center;
                cursor: pointer;
                white-space: nowrap;
            }
            .modal-content .btn {
                padding: 10px 10px;
                background: #028276;
                margin: 10px;
                display: inline-block;
                cursor: pointer;
                border-radius: 5px;
            }
            /* MODAL */

            /* loading */
						.progress {
						  position: absolute;
						  height: 4px;
						  z-index: 10000;
						  display: none;
						  width: 100%;
						  background-color: #2780ca;
						  border-radius: 2px;
						  background-clip: padding-box;
						  margin: 0 0 1rem 0;
						  overflow: hidden; 
						}
						 
						.progress .indeterminate {
						  background-color: #26a69a;
						}
				    .progress .indeterminate:before {
				      content: '';
				      position: absolute;
				      background-color: inherit;
				      top: 0;
				      left: 0;
				      bottom: 0;
				      will-change: left, right;
				      -webkit-animation: indeterminate 2.1s cubic-bezier(0.65, 0.815, 0.735, 0.395) infinite;
				      animation: indeterminate 2.1s cubic-bezier(0.65, 0.815, 0.735, 0.395) infinite;
				    }
				    .progress .indeterminate:after {
				      content: '';
				      position: absolute;
				      background-color: inherit;
				      top: 0;
				      left: 0;
				      bottom: 0;
				      will-change: left, right;
				      -webkit-animation: indeterminate-short 2.1s cubic-bezier(0.165, 0.84, 0.44, 1) infinite;
              animation: indeterminate-short 2.1s cubic-bezier(0.165, 0.84, 0.44, 1) infinite;
				      -webkit-animation-delay: 1.15s;
              animation-delay: 1.15s;
				    }

						@-webkit-keyframes indeterminate {
						  0% {
						    left: -35%;
						    right: 100%; }
						  60% {
						    left: 100%;
						    right: -90%; }
						  100% {
						    left: 100%;
						    right: -90%; }
						}
						@keyframes indeterminate {
						  0% {
						    left: -35%;
						    right: 100%; }
						  60% {
						    left: 100%;
						    right: -90%; }
						  100% {
						    left: 100%;
						    right: -90%; }
						}
						@-webkit-keyframes indeterminate-short {
						  0% {
						    left: -200%;
						    right: 100%; }
						  60% {
						    left: 107%;
						    right: -8%; }
						  100% {
						    left: 107%;
						    right: -8%; }
						}
						@keyframes indeterminate-short {
						  0% {
						    left: -200%;
						    right: 100%; }
						  60% {
						    left: 107%;
						    right: -8%; }
						  100% {
						    left: 107%;
						    right: -8%; }
						}
            /* loading */

            /* rating */
            .rate {
						  border-radius: 8px;
						  font-size: 20px;
						  padding: 8px;
						}
						input[type="radio"] {
						  box-shadow: none;
						}
						.rate {
						  height: auto;
						  display: inline-flex;
						  flex-direction: row-reverse;
					    align-items: center;
					    justify-content: center;
					    width: 100%;
					    margin: auto;
						  /*align-items: flex-start;
						  justify-content: flex-end;*/
						}
						.rate:not(:checked) > input {
						      position: relative;
						    margin-left: -29px;
						    top: 15px;
						    left: -5px;
						    width: 19px;
						    padding-right: 0px;
						    z-index: -10;
						}
						.rate:not(:checked) > label {
						  float:right;
						  width:1em;
						  overflow:hidden;
						  white-space:nowrap;
						  cursor:pointer;
						  font-size: 3rem;
						  color:#ccc;
						  height: 3rem;
						}
						.rate:not(:checked) > label::before {
						  content: '‚òÖ ';
						  position: relative;
						  top: -15px;
						  left: 2px;
						}
						.rate > input:checked ~ label {
						  color: #ffc700;
						}
						.rate > input:checked:focus + label, .rate > input:focus + label {
						  outline: -webkit-focus-ring-color auto 5px;
						}
						.rate:not(:checked) > label:hover,
						.rate:not(:checked) > label:hover ~ label {
						  color: #deb217;
						}
						.rate > input:checked + label:hover,
						.rate > input:checked + label:hover ~ label,
						.rate > input:checked ~ label:hover,
						.rate > input:checked ~ label:hover ~ label,
						.rate > label:hover ~ input:checked ~ label {
						  color: #c59b08;
						}
            /* rating */

            div#help-button {
              position: fixed;
              top: 10px;
              right: 10px;
              z-index: 10000;
              border-radius: 50%;
              text-align: center;
              background: #ffc950;
              font-size: 1.2em;
              padding: 1em;
              border: 1px solid #fcd25e;
              cursor: pointer;
              width: 26px;
              height: 26px;
            }

            div#search-button {
					    position: fixed;
					    bottom: 10px;
		          text-center: center;
					    right: 10px;
					    z-index: 10000;
					    border-radius: 50%;
					    background: #2780ca;
					    font-size: 1.2em;
					    padding: 1em;
					    border: 1px solid #35a9ff;
					    cursor: pointer;
					    width: 26px;
					    height: 26px;
						}
            input[type=text] {
              width: 100%;
              padding: 12px 20px;
              margin: 8px 0;
              display: inline-block;
              border: 1px solid #ccc;
              border-radius: 4px;
              outline: none;
              box-sizing: border-box;
            }
        </style>
    </head>
    <body>
			<div class="progress" id="top-progress-bar">
			  <div class="indeterminate"></div>
			</div>
      <div id="help-button" onclick="TimesApp.showModalHelp();"><span>‚ùì</span></div>
    	<div id="search-button" onclick="TimesApp.search();"><span>üîç</span></div>
        <div id="loading" style="display: none">
            <div class="sk-chase">
              <div class="sk-chase-dot"></div>
              <div class="sk-chase-dot"></div>
              <div class="sk-chase-dot"></div>
              <div class="sk-chase-dot"></div>
              <div class="sk-chase-dot"></div>
              <div class="sk-chase-dot"></div>
            </div>
            <span>loading geodata</span>
        </div>
        <div id="full-map"></div>
        <footer>
          <center><small>Waiting times are estimated</small></center>
          <center>Made with ‚ù§ in Florence | <a href="https://github.com/TheJoin95/covid19-market-waiting-times" target="_blank">&#x1f517; Open Source on Github</a></center>
        </footer>

        <script>
            const API_DOMAIN_AVAILABLE = ['api-geo'];
            const API_DOMAIN = API_DOMAIN_AVAILABLE[Math.floor(Math.random() * API_DOMAIN_AVAILABLE.length)];
            const WaitingTimesAPI = {
            		fallbackGeocodeAPI: 'https://nominatim.openstreetmap.org/search.php?q=%s&format=json',
                geocodeAPI: 'https://api-geo.thejoin.tech/geocode?lat=%s&lng=%s',
                geocodeAPIClient: 'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=pjson&featureTypes=&location=%s,%s',
                // geocodeAPI: 'https://geocode.xyz/%s,%s?json=1',
                logAPI: 'https://api-geo.thejoin.tech/logger',
                getPlaceByNameAPI: 'https://api-geo.thejoin.tech/places/get-by-name?q=%s&address=%s',
                // getPlacesAPI: 'https://api-geo-fr.thejoin.tech/places/explore?q=%s&address=%s&lat=%s&lng=%s',
                getPlacesAPI: 'https://api-geo-fr.thejoin.tech/places/explore?q=%s&address=%s',
                getPlacesAPIFallback: 'https://api-geo-fr.thejoin.tech/places/explore-redis?q=%s&address=%s',
                format: function (str) {
                    var args = [].slice.call(arguments, 1),
                        i = 0;

                    return str.replace(/%s/g, () => args[i++]);
                }
            };

            Number.prototype.toRad = function() {
               return this * Math.PI / 180;
            }

            Number.prototype.toDeg = function() {
               return this * 180 / Math.PI;
            }

            // Lat, Lng, Angle, Range in Km => get point of destination
            // usage: destinationPoint(43.81, 11.13, 90, 10)
            const Utils = {
                updateTimeout: null,
                geoErrorTimeout: null,
                geoErrorFailOverCount: 0,
                sendError: function (requestBody) {
                    requestBody["ua"] = navigator.userAgent;
                    requestBody["date"] = (new Date()).toString();

                    fetch(WaitingTimesAPI.logAPI, {
                        method: 'POST',
                        headers: {
                          'Accept': 'application/json',
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                },
                setDefaultLocation: function (address, lat, lng) {
                  var obj = {"address": address, "latt": lat, "longt": lng};
                  localStorage.setItem("defaultLocation", JSON.stringify(obj));
                },
                getDefaultLocation: function () {
                  return JSON.parse(localStorage.getItem("defaultLocation"));
                },
                searchByNameModal: function () {
                  document.body.removeChild(document.querySelector('.modal'));
                  Utils.openModal(
                    "search-modal",
                    "Search by name and address",
                    '<input type="text" placeholder="Insert market or place name" id="place"><input type="text" placeholder="Insert address or city" id="address">',
                    "Search",
                    function searchByName () {
                      TimesApp.getPlace(
                        document.getElementById('place').value,
                        document.getElementById('address').value
                      );
                      document.body.removeChild(document.querySelector('.modal'));
                    }
                  );
                },
                openModal: function (id, title, content, actionText, actionFn, closeFn) {
                  var id = id || (new Date()).getTime();
                  var h2 = title;
                  var actionText = actionText || 'Send';

                  var divModal = document.createElement('div');
                  divModal.id = id;
                  divModal.className = 'modal';

                  var innerdivModalm = document.createElement('div');
                  innerdivModalm.className = 'modal-content animate-opacity card-4';
                  divModal.appendChild(innerdivModalm);    

                  var headerModal = document.createElement('header');
                  headerModal.className = 'container teal';
                  innerdivModalm.appendChild(headerModal);
                            
                  var containerContentDiv = document.createElement('div');
                  containerContentDiv.className = 'container';
                  innerdivModalm.appendChild(containerContentDiv);

                  containerContentDiv.innerHTML = content || '<p>Did not find what you were looking for? <br/><u style="cursor: pointer" onclick="Utils.searchByNameModal()">Tap here to search by name üîç</u></p><input type="text" id="email" placeholder="Insert an email for an answer or leave blank" /><textarea placeholder="Write here your question or tips" rows="7"></textarea><small><i>Note: this is not a search box</i></small>';

                  var buttonM = document.createElement("span");
                  buttonM.className = 'close-button display-topright';
                  buttonM.setAttribute("onclick", "document.getElementById('"+id+"').style.display='none'");
                  buttonM.innerHTML = "&times;";
                  headerModal.appendChild(buttonM); 

                  var headerM = document.createElement("H2");
                  headerM.innerHTML = h2;
                  headerModal.appendChild(headerM);

                  var footer =  document.createElement('footer');
                  footer.className = 'container teal';
                  innerdivModalm.appendChild(footer);

                  var closeButton = document.createElement("span");
                  closeButton.className = 'btn';
                  if (actionText !== -1)
                  	closeButton.style.float = "right";
                  
                  if (closeFn === undefined) {
                    closeButton.setAttribute("onclick", "document.getElementById('"+ id +"').style.display='none'");
                  }else {
                    closeButton.addEventListener('click', closeFn);
                  }

                  closeButton.innerHTML = "Close";
                  footer.appendChild(closeButton);

                  if (actionText !==-1) {
	                  var actionButton = document.createElement("span");
	                  actionButton.className = 'btn';
	                  if (actionFn === undefined) {
	                    actionButton.setAttribute("onclick", "TimesApp.sendHelp(document.querySelector('.modal-content textarea').value, document.querySelector('.modal-content #email').value)");
	                  } else {
	                    actionButton.addEventListener('click', actionFn);
	                  }

	                  actionButton.innerHTML = actionText;
	                  footer.appendChild(actionButton);
                  }

                  divModal.style.display = "block";

                  document.getElementsByTagName('body')[0].appendChild(divModal); 
                },
                getAccurateCurrentPosition: function (geolocationSuccess, geolocationError, geoprogress, options) {
				    var lastCheckedPosition,
			        locationEventCount = 0,
			        watchID,
			        timerID;

					    options = options || {};

				    var checkLocation = function (position) {
			        lastCheckedPosition = position;
			        locationEventCount = locationEventCount + 1;
			        // We ignore the first event unless it's the only one received because some devices seem to send a cached
			        // location even when maxaimumAge is set to zero
			        if ((position.coords.accuracy <= options.desiredAccuracy) && (locationEventCount > 1)) {
			            clearTimeout(timerID);
			            navigator.geolocation.clearWatch(watchID);
			            foundPosition(position);
			        } else {
			            geoprogress(position);
			        }
				    };

				    var stopTrying = function () {
				        navigator.geolocation.clearWatch(watchID);
				        foundPosition(lastCheckedPosition);
				    };

				    var onError = function (error) {
				        clearTimeout(timerID);
				        navigator.geolocation.clearWatch(watchID);
				        geolocationError(error);
				    };

				    var foundPosition = function (position) {
				        geolocationSuccess(position);
				    };

				    if (!options.maxWait)            options.maxWait = 10000; // Default 10 seconds
				    if (!options.desiredAccuracy)    options.desiredAccuracy = 20; // Default 20 meters
				    if (!options.timeout)            options.timeout = options.maxWait; // Default to maxWait

				    options.maximumAge = 0; // Force current locations only
				    options.enableHighAccuracy = true; // Force high accuracy (otherwise, why are you using this function?)

				    watchID = navigator.geolocation.watchPosition(checkLocation, onError, options);
				    timerID = setTimeout(stopTrying, options.maxWait); // Set a timeout that will abandon the location loop
				},
                destinationPoint: function(lat, lng, brng, dist) {
                   dist = dist / 6371;  
                   brng = brng.toRad();  

                   var lat1 = lat.toRad(), lon1 = lng.toRad();

                   var lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) + 
                                        Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));

                   var lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) *
                                                Math.cos(lat1), 
                                                Math.cos(dist) - Math.sin(lat1) *
                                                Math.sin(lat2));

                   if (isNaN(lat2) || isNaN(lon2)) return null;

                   return [lat2.toDeg(), lon2.toDeg()];
                },
                distanceLatLng: function (lat1, lon1, lat2, lon2) {
                  var R = 6371; // km
                  var dLat = (lat2-lat1).toRad();
                  var dLon = (lon2-lon1).toRad();
                  var lat1 = (lat1).toRad();
                  var lat2 = (lat2).toRad();

                  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
                  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                  var d = R * c;
                  return d;
                }
            };

            const TimesApp = {
                lat: null,
                lng: null,
                address: "",
                zoom: 15,
                lMap: null,
                myPosition: null,
                query: "supermarket",
                isLoading: false,
                place_ids: [],
                icons: [],
                setLoading: function(b) {
                	TimesApp.isLoading = b;
                	var display =  (b === true) ? 'block' : 'none';
                	document.getElementById('top-progress-bar').style.display = display;
                },
                initIcon: function () {
                  var assetsPrefix = "/assets/custom-marker/";
                  const iconAssets = ['0', '1', '2', '3', '4', '5', '6', '7'];

                  for (const key in iconAssets) {
                    TimesApp.icons.push(L.icon({
                        iconUrl: assetsPrefix + iconAssets[key] + '.png',

                        iconSize:     [42, 42], // size of the icon
                        iconAnchor:   [20, 32], // point of the icon which will correspond to marker's location
                        popupAnchor:  [2, -20] // point from which the popup should open relative to the iconAnchor
                    }));
                  }
                },
                initMap: function () {
                    TimesApp.toggleSpinner();
                    TimesApp.initIcon();
                    TimesApp.lMap = L.map('full-map').setView([TimesApp.lat, TimesApp.lng], TimesApp.zoom);
                    L.tileLayer(
                        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 18,
                            minZoom: 14,
                            attribution: 'Map data <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
                        }
                    ).addTo(TimesApp.lMap);

                    TimesApp.lMap.zoomControl.remove()

                    TimesApp.myPosition = L.circle([TimesApp.lat, TimesApp.lng], {
                        color: '#0696c1',
                        fillColor: '#06aee0',
                        fillOpacity: 0.5,
                        radius: 50
                    }).bindPopup("Your position").addTo(TimesApp.lMap);

                    TimesApp.lMap.on("moveend", async function () {
                        clearTimeout(Utils.updateTimeout);
                        let center = TimesApp.lMap.getCenter();
                        console.log("new center ", center.toString());

                        if (Utils.distanceLatLng(TimesApp.lat, TimesApp.lng, center.lat, center.lng) >= 2) {
                            TimesApp.lat = parseFloat(center.lat);
                            TimesApp.lng = parseFloat(center.lng);
                            Utils.updateTimeout = setTimeout(async function () {
                                await TimesApp.updateAddress(-1);
                                await TimesApp.updateBound(TimesApp.lat, TimesApp.lng);
                            }, 1000);
                            TimesApp.getPharmacies();
                        }

                    });
                    
                    TimesApp.showLegend();
                    TimesApp.getPlaces();
                },
                // getMarkerPlaceColor: function (d) {
                //     return d > 60 ? ['#BD0026', '#cc0c33'] :
                //         d > 45  ? ['#800026', '#ff2929'] :
                //         d > 30  ? ['#e33c17', '#fa4c25'] :
                //         d > 25  ? ['#de691b', '#fc7e2a'] :
                //         d > 15   ? ['#e6a910', '#ffbf1c'] :
                //         d > 10   ? ['#d9e30e', '#ecf716'] :
                //                     ['#1dbd00', '#1fcc00'];
                // },
                getMarkerPlaceColor: function (d) {
                    return d > 60 ? [6, '#cc0c33'] :
                        d > 45  ? [5, '#ff2929'] :
                        d > 30  ? [4, '#fa4c25'] :
                        d > 25  ? [3, '#fc7e2a'] :
                        d > 15   ? [2, '#ffbf1c'] :
                        d > 10   ? [1, '#ecf716'] :
                                    [0, '#1fcc00'];
                },
                showLegend: function () {
                    var legend = L.control({position: 'bottomright'});

                    legend.onAdd = function (map) {

                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [5, 10, 15, 25, 30, 45, 60],
                            labels = [],
                            from, to;

                        for (var i = 0; i < grades.length; i++) {
                            from = grades[i];
                            to = grades[i + 1];

                            labels.push(
                                '<i style="background:' + TimesApp.getMarkerPlaceColor(grades[i]+1)[1] + '"></i> ' +
                                from + (to ? '&ndash;' + to : '+'));
                        }

                        div.innerHTML = "Minutes:<br>" + labels.join('<br>');
                        return div;
                    };

                    legend.addTo(TimesApp.lMap);
                },
                getWaitTime: function (place) {
                    const hour = (new Date()).getHours();
                    const weekDay = ((new Date()).getDay() === 0) ? 6 : (new Date()).getDay() - 1;

                    var maxTimeSpent = meanTimeSpent = minTimeSpent = 0;

                    if (place["time_spent"] !== undefined && place["time_spent"].length > 0) {
                      place["time_spent"][0] = (place["time_spent"][0] == 1) ? 60 : place["time_spent"][0];
                      place["time_spent"][1] = (place["time_spent"][1] == 1) ? 60 : place["time_spent"][1];
                      maxTimeSpent = Math.max(...place["time_spent"]);
                      minTimeSpent = Math.min(...place["time_spent"]);
                      meanTimeSpent = (place["time_spent"].reduce(function(a, b) { return a + b; }, 0)) / 2;
                    }

                    const cPopularity = place["current_popularity"] || 0;

                    var waitTimes = popTimes = 0;
                    if (place["time_wait"] !== undefined && place["time_wait"].length > 0)
                        waitTimes = place["time_wait"][weekDay]["data"][hour];
                    
                    popTimes = place["populartimes"][weekDay]["data"][hour];


                    var meanIntersectPop = 0;

                    const diffPopTimes = (popTimes - cPopularity);
                    var increase = (popTimes > 0) ? meanTimeSpent : 0;
                    if (cPopularity !== 0 && (popTimes/cPopularity) <= 2 && waitTimes > 0) {
                    	if (diffPopTimes <= 0) {
                    		increase = maxTimeSpent + (Math.ceil((cPopularity/2)/5)*5);
                    	} else if (diffPopTimes > 0 && diffPopTimes < (popTimes/5)) {
                    		increase = meanTimeSpent;
                    	} else if(diffPopTimes >= (popTimes/5) && diffPopTimes <= (popTimes/3)) {
                    		increase = minTimeSpent;
                    	} else if (diffPopTimes > (popTimes/3)) {
                    		increase = 5;
                    	}
                    }

                    meanIntersectPop += increase;

                    var waitTime = Math.ceil(waitTimes + meanIntersectPop);

                    if (popTimes !== 0 && cPopularity >= 18)
                        waitTime += 5; // relative error, white rumor

                    if (waitTime === 0 && meanTimeSpent === 0)
                    	waitTime = 'No information about ';

                    return [place["populartimes"][weekDay]["data"][hour], waitTime];
                },
                getPharmacies: function () {
                    console.log("Getting pharmacy");
                    TimesApp.getPlaces("pharmacy");
                },
                getPlace: function (q, address) {
                  TimesApp.setLoading(true);
                    const fetchUrl = WaitingTimesAPI.format(WaitingTimesAPI.getPlaceByNameAPI, q, address);
                    ga('send', 'event', 'Request', 'Place', (q + ' ' + address));
                    fetch(fetchUrl)
                        .then((r) => { if (r.ok) return r.json(); })
                        .then((places) => {
                          const markers = TimesApp.setPlaceOnMap(places);
                          if (markers.length > 0) {
                            markers[markers.length-1].openPopup();
                          } else {
                            alert("Unfortunally " + q + " does not have any information about waiting times");
                          }
                        })
                        .catch((r) => Utils.sendError({url: fetchUrl, message: r.toString()}));
                },
                getPlaces: function (query) {
                    query = query || TimesApp.query;
                    TimesApp.setLoading(true);
                    // const fetchUrl = WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPI, query, TimesApp.address, TimesApp.lat, TimesApp.lng);
                    if (Math.floor(Math.random() * 16) == 10) {
                      var headers = new Headers();
                      headers.append('x-geo-lat', TimesApp.lat);
                      headers.append('x-geo-lng', TimesApp.lng);
                      const fetchUrl = WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPIFallback, query, TimesApp.address);
                      ga('send', 'event', 'Request', 'Places', TimesApp.address);
                      fetch(fetchUrl, {headers: headers})
                          .then((r) => { if (r.ok) return r.json(); })
                          .then((places) => TimesApp.setPlaceOnMap(places))
                          .catch((r) => Utils.sendError({url: fetchUrl, message: r.toString()}));
                    } else {
                      const fetchUrl = WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPI, query, TimesApp.address);
                      ga('send', 'event', 'Request', 'Places', TimesApp.address);
                      fetch(fetchUrl)
                          .then((r) => { if (r.ok) return r.json(); })
                          .then((places) => TimesApp.setPlaceOnMap(places))
                          .catch((r) => Utils.sendError({url: fetchUrl, message: r.toString()}));
                    }

                },
                setPlaceOnMap: function (places) {
                  console.log(places);
                  TimesApp.setLoading(false);
                  var pointMarkers = [];

                  for (const key in places) {
                    if (places[key]["populartimes"] === undefined || TimesApp.place_ids.indexOf(places[key]["place_id"]) !== -1) continue;
                    
                    let waitTimeArr = TimesApp.getWaitTime(places[key]);

                    let waitTime = waitTimeArr[1];
                    // let radius = waitTime + 80;
                    let colors = TimesApp.getMarkerPlaceColor(waitTime);
                    let message = "<b>" + places[key]["name"] + "</b><br><small>" + places[key]["address"] + "</small><br/><i>" + waitTime + "min</i> of line";

                    // if (isNaN(radius)) radius = 80;
                    
                    if (waitTimeArr[0] === 0) {
                        colors = ["7", "#777"];
                        // radius = 80;
                        message = "<i>Closed</i><br/>" + message;
                    }

                    const pointMarker = L.marker([places[key]["coordinates"]["lat"], places[key]["coordinates"]["lng"]], {icon: TimesApp.icons[colors[0]]});

                    pointMarker.bindPopup(message);
                    pointMarker.addTo(TimesApp.lMap);
                    pointMarkers.push(pointMarker);
                    
                    TimesApp.place_ids.push(places[key]["place_id"]);
                  }
                  return pointMarkers;
                },
                updateAddressAwait: async function (initMap) {
                    initMap = initMap || true;
                    var r = await fetch(WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI, TimesApp.lat, TimesApp.lng));
                    r = (r.ok) ? await r.json() : {staddress: '', city: ''};
                    r.staddress = (typeof(r.staddress) === 'object' || r.staddress === undefined) ? '' : r.staddress;
                    r.city = (typeof(r.city) === 'object' || r.city === undefined) ? '' : r.city;

                    TimesApp.address = (r.staddress !== '') ? r.staddress + ', ' : '';
                    TimesApp.address += r.city;
                    (initMap === true) ? TimesApp.initMap() : TimesApp.getPlaces();
                    ga('send', 'event', 'Request', 'Geocode', WaitingTimesAPI.geocodeAPI);
                },
                updateAddress: async function (initMap) {
                    initMap = initMap || true;
                    TimesApp.setLoading(true);
                    var availableUrls = [
                      WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI, TimesApp.lat, TimesApp.lng),
                      WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPIClient, TimesApp.lng, TimesApp.lat),
                      WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPIClient, TimesApp.lng, TimesApp.lat)
                    ];

                    var keyUrl = Math.floor(Math.random() * availableUrls.length);
                    const fetchUrl = availableUrls[keyUrl];

                    var r = await fetch(fetchUrl);
                    var json = { staddress: '', city: ''};
                    if((r.ok)) {
                      json = await r.json();
                    } else {
                      Utils.sendError({url: fetchUrl, message: r.toString()});
                      return false;
                    }
                    
                    json.staddress = (typeof(json.staddress) === 'object' || json.staddress === undefined) ? '' : json.staddress;
                    json.city = (typeof(json.city) === 'object' || json.city === undefined) ? '' : json.city;

                    if (json.staddress === '' && json.address !== undefined)
                      json.staddress = (json.address["Address"] === undefined) ? '' : json.address["Address"];

                    if (json.city === '' && json.address !== undefined)
                      json.city = (json.address["City"] === undefined) ? '' : json.address["City"];

                    TimesApp.address = (json.staddress !== '') ? json.staddress + ', ' : '';
                    TimesApp.address += json.city;
                    (initMap === true) ? TimesApp.initMap() : TimesApp.getPlaces();
                  
                    //.catch((r) => Utils.sendError({url: fetchUrl, message: r.toString()}));

                    /*fetch(fetchUrl)
                        .then((r) => { return ((r.ok) ? r.json() : {staddress: '', city: ''}); })
                        .then((r) => { 
                            r.staddress = (typeof(r.staddress) === 'object' || r.staddress === undefined) ? '' : r.staddress;
                            r.city = (typeof(r.city) === 'object' || r.city === undefined) ? '' : r.city;

                            TimesApp.address = (r.staddress !== '') ? r.staddress + ', ' : '';
                            TimesApp.address += r.city;
                            (initMap === true) ? TimesApp.initMap() : TimesApp.getPlaces();
                        })
                        .catch((r) => Utils.sendError({url: fetchUrl, message: r.toString()}));*/

                    ga('send', 'event', 'Request', 'Geocode', ((keyUrl == 0) ? WaitingTimesAPI.geocodeAPI : WaitingTimesAPI.geocodeAPIClient));
                },
                updateBound: async function (originLat, originLng) {
                  TimesApp.setLoading(true);
                  for (var i = 0; i <= 360; i += 90) {
                      let destLatLng = Utils.destinationPoint(originLat, originLng, i, 2.5);
                      TimesApp.lat = parseFloat(destLatLng[0]);
                      TimesApp.lng = parseFloat(destLatLng[1]);

                      await new Promise(resolve => setTimeout(resolve, 3000));
                      await TimesApp.updateAddress(-1);
                  }
                },
                geoSuccess: async function (position) {
                  if (position === undefined) {
                    TimesApp.geoError();
                    return false;
                  }
                  TimesApp.lat = parseFloat(position.coords.latitude);
                  TimesApp.lng = parseFloat(position.coords.longitude);

                  await TimesApp.updateAddressAwait();
                  await TimesApp.updateBound(TimesApp.lat, TimesApp.lng);
                  ga('send', 'event', 'Geolocation', 'GeoSuccess', 'true');
                },
                showModalHelp: function () {
                    if (document.querySelector('.modal') !== null)
                      document.body.removeChild(document.querySelector('.modal'));
                    Utils.openModal("help-modal", "Need help? Do you want to ask something?");
                },
                sendReview: function (rate) {
                	var rate = rate || '0';
                	ga('send', 'event', 'Review', 'Rate', rate);
                	Utils.sendError({rate: rate});
                	localStorage.setItem("sended_review", "yes");
                	document.querySelector('.modal-content div.container').innerHTML = '<h2>Feedback sent, thank you!</h2>';
                  setTimeout(function() {
                      document.body.removeChild(document.getElementById('rating-modal'));
                  }, 1200);
                },
                sendHelp: function (message, email) {
                    var email = email || "";
                    Utils.sendError({message: message, email: email, help: true});
                    document.querySelector('.modal-content div.container').innerHTML = '<h2>Message sent, thank you!</h2>';
                    setTimeout(function() {
                        document.getElementById('help-modal').style.display='none';
                    }, 1200);
                },
                fallbackGeocodeCall: async function (address) {
                	var r = await fetch(WaitingTimesAPI.format(WaitingTimesAPI.fallbackGeocodeAPI, address));
                	var json = await r.json();

                	if (json.length > 0 && json[0]['lat'] !== undefined) {
                		json['latt'] = json[0]['lat'];
                		json['longt'] = json[0]['lon'];
                	} else {
                		json["error"] = true;
                	}

                	return json;
                },
                search: async function () {
                	TimesApp.address = prompt("This app need your gps position or at least your address or your city:", "");
                  TimesApp.setLoading(true);
                	if (TimesApp.address === null)
                		return false;

                	if (TimesApp.address != "") {
                				ga('send', 'event', 'Request', 'Search', TimesApp.address);
                        const fetchUrl = "https://geocode.xyz/" + TimesApp.address + "?json=1";

                        var r = await fetch(fetchUrl);   
                      	var json = await r.json();
                      	if (!r.ok || (json['error'] !== undefined && json['error']['code'] === '006')) {
                      		json = await TimesApp.fallbackGeocodeCall(TimesApp.address);
                      	}
                            
                        if (json["error"] !== undefined) {
                          setTimeout(function () {
                            alert("No results. Check your address/city and try again. Please write the city in english");
                            Utils.sendError({url: fetchUrl, message: json["error"]});
                            TimesApp.search();
                          }, 2000);
                          return false;
                        }
                        
                        TimesApp.getPlaces();
                        TimesApp.lat = parseFloat(json.latt);
                        TimesApp.lng = parseFloat(json.longt);
                        TimesApp.lMap.setView([TimesApp.lat, TimesApp.lng], TimesApp.zoom);
                        TimesApp.updateBound(TimesApp.lat, TimesApp.lng);
                    }
                },
                promptAddress: function () {
                	return prompt("This app need your gps position or at least your address or your city:", "");
                },
                geoError: async function (e) {
                  clearTimeout(Utils.geoErrorTimeout);
                  TimesApp.address = TimesApp.promptAddress();

                  if (TimesApp.address === null) {
                  	Utils.geoErrorFailOverCount += 1;
                  	// Florence by default
                  	TimesApp.lat = 43.7740236;
                  	TimesApp.lng = 11.253233;
                  	TimesApp.address = "Firenze";

                  	if (TimesApp.lMap === null)
                  		TimesApp.initMap();

                  	// First failover test
                  	if (Utils.geoErrorFailOverCount < 2) {
	                  	Utils.geoErrorTimeout = setTimeout(function () {
	                  		TimesApp.geoError();
	                  	}, 1000);
                  	}
                  } else {
                  	TimesApp.address = TimesApp.address.trim();
                  }


                  if (TimesApp.address != "") {
                  	ga('send', 'event', 'Geolocation', 'GeoError', TimesApp.address);
                    const fetchUrl = "https://geocode.xyz/" + TimesApp.address + "?json=1";

                    // var json = Utils.getDefaultLocation();
                    // if (json === null) {
                    var r = await fetch(fetchUrl);   
                    var json = await r.json();
                    if (!r.ok || (json['error'] !== undefined && json['error']['code'] === '006')) {
                      json = await TimesApp.fallbackGeocodeCall(TimesApp.address);
                    }
                        
                    if (json["error"] !== undefined) {
                      setTimeout(function () {
                        alert("No results. Check your address/city and try again. Please write the city in english");
                        Utils.sendError({url: fetchUrl, message: json["error"]});
                        TimesApp.search();
                      }, 2000);
                      return false;
                    }
                      //Utils.setDefaultLocation(TimesApp.address, json.latt, json.longt);
                    // }

                    TimesApp.lat = parseFloat(json.latt);
                    TimesApp.lng = parseFloat(json.longt);
                    if (TimesApp.lMap === null) {
                      TimesApp.initMap();
                      TimesApp.updateBound(TimesApp.lat, TimesApp.lng);
                    } else {
                      TimesApp.getPlaces();
                      TimesApp.updateBound(TimesApp.lat, TimesApp.lng);
                    }

                    /*fetch(fetchUrl)
                        .then(async (r) => {
                        	var json = await r.json();
                        	if (json['error'] !== undefined && json['error']['code'] === '006') {
                        		json = await TimesApp.fallbackGeocodeCall(TimesApp.address);
                        	}

                        	return json;
                        })
                        .then((r) => {
                            if (r["error"] !== undefined) {
                              setTimeout(function () {
                                alert("No results. Check your address/city and try again. Please write the city in english");
                                Utils.sendError({url: fetchUrl, message: r["error"]});
                                TimesApp.geoError();
                              }, 2000);
                              return false;
                            }

                            TimesApp.lat = parseFloat(r.latt);
                            TimesApp.lng = parseFloat(r.longt);
                            if (TimesApp.lMap === null) {
                              TimesApp.initMap();
                              TimesApp.updateBound(TimesApp.lat, TimesApp.lng);
                            } else {
                              TimesApp.getPlaces();
                              TimesApp.updateBound(TimesApp.lat, TimesApp.lng);
                            }
                        })
                        .catch((r) => Utils.sendError({url: fetchUrl, message: r.toString()}));*/
                  }
                },
                toggleSpinner: function () {
                    const spinnerEl = document.getElementById('loading');
                    let displayProp = 'block';
                    if (spinnerEl.style.display == 'block')
                        displayProp = 'none';
                    
                    spinnerEl.style.display = displayProp;
                }
            };

            window.onerror = function(errorMessage, errorUrl, errorLine) {

            	const requestBody = {
            		date: (new Date()).toString(),
            		ua: navigator.userAgent,
            		errorMessage: errorMessage,
            		errorUrl: errorUrl,
            		errorLine: errorLine
            	};

                Utils.sendError(requestBody);
            }

            document.addEventListener('DOMContentLoaded', function () {
                const mapEl = document.getElementById('full-map');
                mapEl.style.height = window.innerHeight - 50 + 'px';

                TimesApp.toggleSpinner();
                
                Utils.getAccurateCurrentPosition(
                	TimesApp.geoSuccess,
                	TimesApp.geoError,
                	function(p) {
                		console.log(p);
                	},
                	{
                		desiredAccuracy: 100,
                		maxWait: 8000
                	}
                );

                if (localStorage.getItem('sended_review') !== 'yes') {
	                setTimeout(function () {
	                	Utils.openModal('rating-modal', 'Please, take time to rate this project', `
											<h4>Your feedback is very important to understand if the estimates are correct or not. Together we can build something useful!</h4>
											<div class="rate">
											  <input type="radio" id="star5" name="rate" value="5">
											  <label onclick="TimesApp.sendReview(this.getAttribute('data-value'))" for="star5" data-value="5" title="5 stars">5 stars</label>
											  <input type="radio" id="star4" name="rate" value="4">
											  <label onclick="TimesApp.sendReview(this.getAttribute('data-value'))" for="star4" data-value="4" title="4 stars">4 stars</label>
											  <input type="radio" id="star3" name="rate" value="3">
											  <label onclick="TimesApp.sendReview(this.getAttribute('data-value'))" for="star3" data-value="3" title="3 stars">3 stars</label>
											  <input type="radio" id="star2" name="rate" value="2">
											  <label onclick="TimesApp.sendReview(this.getAttribute('data-value'))" for="star2" data-value="2" title="2 stars">2 stars</label>
											  <input type="radio" id="star1" name="rate" value="1">
											  <label onclick="TimesApp.sendReview(this.getAttribute('data-value'))" for="star1" data-value="1" title="1 star">1 star</label>
											</div>
											`, -1);
	                }, 100 * 1000);
                }
            });

            window.addEventListener('appinstalled', function() {
            	ga('send', 'event', 'PWA', 'Installed', 'true');
						  Utils.sendError({"pwa_installed": true});
						});


            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-10999521-2', 'auto');
            ga('set', 'anonymizeIp', true);
            ga('send', 'pageview');
            
            try {
              navigator.serviceWorker.register('sw.js');
            } catch (e) {
              console.log(e);
            }
        </script>
    </body>
</html>